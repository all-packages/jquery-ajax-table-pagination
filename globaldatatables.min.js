/* Plugin Name : Custome Data Table, 
 * vaersion : 1.0.0
 * Developed By : Prasanna Kumar
 * Date : 18/02/2019
 * Features : Table prepare with pagination from server side and local, search, show per page, search 
 */
!function(a){var t=[],e=[],i="",n=1,l={table:"",totalcount:0},r="",o=[],s=[];a.fn.customeDataTable=function(c){var d=a.extend({tableIndex:1,data:{},searchcolumns:[],headers:[],structure:"json",orderby:0,perpage:10,actionurl:"",actiontype:"get",search:!0,localpagination:!0,serverpagination:!0,newcall:!1,tableprepare:"",skip:1},c);function p(){var t=d.data;t.orderby=d.orderby,t.limit=d.perpage,t.skip=d.skip,t.pagination=d.serverpagination;var e="";return a.ajax({url:d.actionurl,type:d.actiontype,data:JSON.stringify(t),async:!1,success:function(a){var t=(r="string"==typeof a?JSON.parse(a):a).data;if("json"===d.structure)t=JSON.stringify(r),e=window[d.tableprepare](t);else{e=t;var n=d.perpage,l=b(r.totalcount,n,d.skip),o="<div>"+f()+e+l+"</div>";i.html(o)}searchValue=""},error:function(){}}),e={table:e,totalcount:r.totalcount}}function u(){var a=d.headers;if(a.length>0){var t="<thead>";if("local"===d.structure)t+=i.find("table thead").html();else{if(t+="<tr>",a.length>0)for(var e in a)t+="<th>"+a[e]+"</th>";t+="</tr>"}return t+="</thead>"}return""}function h(){l=p();var a="<div>";a+=f();var t=d.perpage,e=b(l.totalcount,t,d.skip),i=u();return a+=""!==i?'<div><table class="table table-bordered">'+i+l.table+"</table></div>"+e+"</div>":"<div>"+l.table+"</div>"+e+"</div>"}function $(){return!0!==o[n]&&!0!==d.newcall||(o[n]=!1,l=p(),d.skip=1),g()}function g(){var t=d.perpage,e=function(){$totalCount=0,$columns=[],$tableIndex=[],$i=0,$searchValue=a(".datatable-search-input-"+d.tableIndex).val(),"undefined"==typeof $searchValue&&($searchValue="");$searchcolumns=d.searchcolumns,$searchcolumns.length<=0?i.find("th").each(function(){$columnName=a(this).text(),$columns[$i]=$columnName,$i++}):i.find("th").each(function(){$columnName=a(this).text(),a.inArray($columnName,$searchcolumns)>-1&&($columns[$i]=$columnName),$i++});return a.each(i.find("table tbody tr"),function(){if($jsonrow={},$match=!1,a.each(a(this).find("td"),function(){$tdIndex=a(this).index(),$key=$columns[$tdIndex],"undefined"!=typeof $key&&($jsonrow[$key]=a(this).text())}),$index=a(this).index(),""===$searchValue)$totalCount++,$tableIndex.push($index);else{for(var t in $searchValue=$searchValue.toLowerCase(),$jsonrowCheck=!1,$jsonrow)if(-1!==$jsonrow[t].toLowerCase().indexOf($searchValue)){$jsonrowCheck=!0;break}!0===$jsonrowCheck&&($totalCount++,$tableIndex.push($index))}}),$json={totalCount:$totalCount,tableIndex:$tableIndex},JSON.stringify($json)}();e=JSON.parse(e);var n,l,r=(d.skip-1)*t,o=r+t,s=e.totalCount,c="";!0===d.localpagination&&(c=b(s,t,d.skip),e.tableIndex=e.tableIndex.slice(r,o)),n=e.tableIndex,l=i.find("tbody tr"),a.each(l,function(t,e){-1==a.inArray(t,n)?i.find("tbody tr").eq(t).hide():i.find("tbody tr").eq(t).show()});var p=f();return i.find("#searchHtml").length>0?i.find("#searchHtml").replaceWith(p):i.prepend(p),i.find("#paginationHtml").length>0?i.find("#paginationHtml").replaceWith(c):i.append(c),""}function b(a,t,e){d.skip=parseInt(e),$pagination=Math.ceil(a/t);var i="";if($pagination>1){for($paginationLength=5,$p=1,i+='<div id="paginationHtml" class="text-center" ><ul id="pagination" class="pagination">',$pagination>5?$pagination>d.skip?d.skip>=5&&(i+='<li class="" style="cursor: pointer;"   ><a data-id="'+d.tableIndex+'" id="paginationPage-'+$p+'" onclick="$(this).clickPagination(this);" class="paginationPage">First</a></li><li><a>...</a></li>',$p=d.skip-3,$paginationLength=d.skip+1):(i+='<li  style="cursor: pointer;" ><a data-id="'+d.tableIndex+'" id="paginationPage-'+$p+'" onclick="$(this).clickPagination(this);" class="paginationPage">First</a></li><li><a>...</a></li>',$p=d.skip-4,$paginationLength=$pagination):$paginationLength=$pagination,$p;$p<=$paginationLength;$p++)$p===d.skip?$active="active":$active="",i+='<li class="'+$active+'" style="cursor: pointer;"><a onclick="$(this).clickPagination(this);" data-id="'+d.tableIndex+'" id="paginationPage-'+$p+'" class="paginationPage">'+$p+"</a></li>";$pagination>5&&($last=$pagination-d.skip,$last>=2&&(i+='<li><a>...</a></li><li style="cursor: pointer;"><a onclick="$(this).clickPagination(this);" data-id="'+d.tableIndex+'" id="paginationPage-'+$pagination+'" class="paginationPage">Last</a></li>')),i+="</ul>",i+="</div>"}return i}function f(){if($searchValue=a(".datatable-search-input-"+d.tableIndex).val(),"undefined"==typeof $searchValue&&($searchValue=""),!1===d.search)return"";var t="";return!1===d.serverpagination||!0===d.localpagination&&"local"===d.structure?t='<div id="searchHtml" class="pull-right"><ul style="margin: 9px;"  class="pagination" ><li style="float: left;"><input onkeyup="$(this).searchDatatable(this);" type="text" value="'+$searchValue+'" name="search" data-id="'+d.tableIndex+'" class="form-control datatable-search datatable-search-input-'+d.tableIndex+'" id="datatable-search"  /></li></ul></div>':!0===d.serverpagination&&"local"!==d.structure&&(t='<div id="searchHtml" class="pull-right"><ul style="margin: 9px;" class="pagination" ><li style="float: left;"><input type="text" value="'+$searchValue+'" name="search" class="form-control datatable-search-input-'+d.tableIndex+'"  /></li><li><button style="padding: 6.5px 18px;margin-left: 7px;" data-id="'+d.tableIndex+'" type="button" class="btn btn-sm btn-primary datatable-search" onclick="$(this).searchDatatable(this);" id="datatable-search">Search</button></li></ul></div>'),t}function v(a,t,i){i=i||!1;var n=d.data;n.search=t;var l=d.tableIndex;!1===i||!0===e[l].newcall?e[l].skip=1:e[l].skip=i,a.customeDataTable({tableIndex:d.tableIndex,data:n,searchcolumns:d.searchcolumns,headers:d.headers,structure:d.structure,orderby:d.orderby,perpage:d.perpage,actionurl:d.actionurl,actiontype:d.actiontype,tableprepare:d.tableprepare,search:d.search,localpagination:d.localpagination,serverpagination:d.serverpagination,newcall:d.newcall,skip:d.skip})}n=d.tableIndex,this.each(function(){void 0===s[n]||!0===s[n]?(o[n]=!0,s[n]=!0,t[n]=a(this),e[n]=d,i=a(this)):(i=t[n],d=e[n]);var r="",c=d.structure;"local"===c?(o[n]=!1,d.serverpagination=!1,r=$()):r="json"===c?function(){var a="";!0===d.serverpagination?a=h():(d.serverpagination=!1,a=function(){if(!0===o[n]||!0===d.newcall){d.skip=1,l=p(),o[n]=!1;var a="";if(!0===d.localpagination){var t=d.perpage,e="";e=l.totalcount,a=b(e,t,d.skip)}var r="<div>",s=u();r+=f(),r+=""!==s?'<div><table class="table table-bordered">'+s+l.table+"</table></div>"+a+"</div>":"<div>"+l.table+"</div>"+a+"</div>",i.html(r)}g()}());return a}():function(){var a="";!0===d.serverpagination?a=h():(d.serverpagination=!1,a=$());return a}(),r&&i.html(r)}),a.fn.setCursorPosition=function(a){this.each(function(t,e){e.setSelectionRange&&e.setSelectionRange(a,a)})},a.fn.searchDatatable=function(t){$dataid=a(t).attr("data-id"),console.log($dataid),d.tableIndex=$dataid,e[$dataid].tableIndex=$dataid,!1===d.serverpagination&&(o[$dataid]=!1),$searchValue=a(".datatable-search-input-"+$dataid).val(),"undefined"==typeof $searchValue&&($searchValue=""),e[$dataid].newcall=!1,s[$dataid]=!1,console.log($searchValue),v(i,$searchValue),console.log($searchValue);var n=$searchValue.length;console.log(n),a(".datatable-search-input-"+$dataid).focus().setCursorPosition(n)},a.fn.clickPagination=function(t){var n=a(t).attr("id").split("-"),l=parseInt(n[1]);$dataid=a(t).attr("data-id"),console.log($dataid),!1===d.serverpagination&&(o[$dataid]=!1),d.tableIndex=$dataid,e[$dataid].tableIndex=$dataid,s[$dataid]=!1,e[$dataid].newcall=!1,v(i,"",l)}}}(jQuery);